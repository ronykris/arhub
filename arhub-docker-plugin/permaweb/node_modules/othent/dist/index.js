"use strict";var t=require("axios"),a=require("@auth0/auth0-spa-js"),e=require("jwt-decode"),n=require("jwk-to-pem"),r=require("jsrsasign"),o=require("crypto-js");async function i(t){const a=await crypto.subtle.digest("SHA-256","string"!=typeof t?t:(new TextEncoder).encode(t));return Array.from(new Uint8Array(a)).map((t=>t.toString(16).padStart(2,"0"))).join("")}exports.Othent=async function(s){const c=s.API_ID,d=window.location.href;return t({method:"POST",url:"https://server.othent.io/use-othent",data:{API_ID:c,callbackURL:d}}).then((s=>{if(!1===s.data.success)throw new Error("Please specify an API ID (you can get one from Othent.io)");const d=()=>a.createAuth0Client({domain:"auth.othent.io",clientId:"dyegx4dZj5yOv0v0RkoUsc48CIqaNS6C",authorizationParams:{redirect_uri:window.location.origin}});function u(t,a){return t.getTokenSilently({detailedResponse:!0,authorizationParams:a,cacheMode:"off"})}async function h(t){let a;if(t instanceof File)a=await async function(t){return new Promise(((a,e)=>{const n=new FileReader;n.onload=()=>{const t=n.result,e=Buffer.from(t);a(e)},n.onerror=e,n.readAsArrayBuffer(t)}))}(t);else if("string"==typeof t)a=Buffer.from(t,"utf8");else if(Buffer.isBuffer(t))a=t;else if(t instanceof ArrayBuffer||t instanceof SharedArrayBuffer)a=Buffer.from(t);else{if(!(t instanceof Uint8Array))throw new Error("Invalid data, we accept: string | Buffer | ArrayBuffer | SharedArrayBuffer | Uint8Array | File");a=Buffer.from(t.buffer)}return a}async function l(){const t=await d(),a={transaction_input:JSON.stringify({othentFunction:"idToken"})},n=(await u(t,a)).id_token,r=e(n);if(r.contract_id)return delete r.nonce,delete r.sid,delete r.aud,delete r.iss,delete r.iat,delete r.exp,delete r.updated_at,r;throw new Error('{ success: false, message: "Please create a Othent account" }')}return{getAPIID:async function(){const t=await d(),a={transaction_input:JSON.stringify({othentFunction:"API_ID"})},n=(await u(t,a)).id_token,r=e(n);if(r.contract_id)return{API_ID:r.API_ID};throw new Error('{ success: false, message: "Please create a Othent account" }')},queryWalletAddressTxns:async function(a){return await t({method:"POST",url:"https://server.othent.io/query-wallet-address-txns",data:{walletAddress:a.walletAddress}}).then((t=>t.data)).catch((t=>{throw t}))},ping:async function(){return await t({method:"GET",url:"https://server.othent.io/"}).then((t=>t.data)).catch((t=>{throw t}))},logIn:async function(){const a=await d();if(await a.isAuthenticated())return await l();{const n={authorizationParams:{transaction_input:JSON.stringify({othentFunction:"idToken"}),redirect_uri:window.location.origin}};let r=null,o="";try{await a.loginWithPopup(n);const t={transaction_input:JSON.stringify({othentFunction:"idToken"})};o=(await u(a,t)).id_token,r=e(o)}catch(t){throw t instanceof Error&&t.message,new Error("Your browser is blocking us! Please turn off your shields or allow cross site cookies! :)")}return r&&r.contract_id?(delete r.nonce,delete r.sid,delete r.aud,delete r.iss,delete r.iat,delete r.exp,delete r.updated_at,r):await t({method:"POST",url:"https://server.othent.io/create-user",data:{JWT:o,API_ID:c}}).then((t=>{const a=t.data;return{contract_id:a.contract_id,given_name:a.given_name,family_name:a.family_name,nickname:a.nickname,name:a.name,picture:a.picture,locale:a.locale,email:a.email,email_verified:a.email_verified,sub:a.sub,success:a.success,message:a.message}})).catch((t=>{throw console.log(t.response.data),t}))}},logOut:async function(){const t=await d();return await t.logout({logoutParams:{returnTo:window.location.origin}}),{response:"User logged out"}},userDetails:l,readContract:async function(){const a=await d(),e={transaction_input:JSON.stringify({othentFunction:"idToken"})},n=(await u(a,e)).id_token;return await t({method:"POST",url:"https://server.othent.io/read-contract",data:{JWT:n}}).then((t=>t.data)).catch((t=>{throw console.log(t.response.data),t}))},signTransactionWarp:async function(t){var a;null!==(a=t.tags)&&void 0!==a||(t.tags=[]);const n={function:t.othentFunction,data:{toContractId:t.data.toContractId,toContractFunction:t.data.toContractFunction,txnData:t.data.txnData}},r=await d(),o={transaction_input:JSON.stringify({othentFunction:t.othentFunction,warpData:n})},i=await u(r,o),s=i.id_token;if(!e(s).contract_id)throw new Error('{success: false, message:"Please create a Othent account"}');return{JWT:i.id_token,tags:t.tags}},sendTransactionWarp:async function(a){const e=a.JWT,n=a.tags;return await t({method:"POST",url:"https://server.othent.io/send-transaction",data:{JWT:e,tags:n,API_ID:c}}).then((t=>t.data)).catch((t=>{throw console.log(t.response.data),t}))},signTransactionArweave:async function(t){var a;null!==(a=t.tags)&&void 0!==a||(t.tags=[]);const n=await h(t.data);if(!n)throw new Error("Invalid data, we accept: string | Buffer | ArrayBuffer | SharedArrayBuffer | Uint8Array | File");const r=await i(n),o=await d(),s={transaction_input:JSON.stringify({othentFunction:t.othentFunction,file_hash:r})},c=await u(o,s),l=c.id_token;if(!e(l).contract_id)throw new Error('{ success: false, message: "Please create a Othent account" }');return{data:n,JWT:c.id_token,tags:t.tags}},sendTransactionArweave:async function(t){const a=t.data,e=new Blob([a]),n=new FormData;return n.append("file",e),n.append("dataHashJWT",t.JWT),n.append("API_ID",c),n.append("tags",JSON.stringify(t.tags)),await fetch("https://server.othent.io/upload-data-arweave",{method:"POST",body:n}).then((t=>t.json())).then((t=>t)).catch((t=>{throw console.log(t),t}))},signTransactionBundlr:async function(t){var a;null!==(a=t.tags)&&void 0!==a||(t.tags=[]);const n=await h(t.data);if(!n)throw new Error("Invalid data, we accept: string | Buffer | ArrayBuffer | SharedArrayBuffer | Uint8Array | File");const r=await i(n),o=await d(),s={transaction_input:JSON.stringify({othentFunction:t.othentFunction,file_hash:r})},c=await u(o,s),l=c.id_token;if(!e(l).contract_id)throw new Error('{ success: false, message: "Please create a Othent account" }');return{data:n,JWT:c.id_token,tags:t.tags}},sendTransactionBundlr:async function(t){const a=t.data,e=new Blob([a]),n=new FormData;return n.append("file",e),n.append("dataHashJWT",t.JWT),n.append("API_ID",c),n.append("tags",JSON.stringify(t.tags)),await fetch("https://server.othent.io/upload-data-bundlr",{method:"POST",body:n}).then((t=>t.json())).then((t=>t)).catch((t=>{throw console.log(t),t}))},initializeJWK:async function(a){const e=a.privateKey,r=JSON.stringify(e),o=JSON.parse(r),i=n(o),s=await d(),h={transaction_input:JSON.stringify({othentFunction:"initializeJWK",warpData:{function:"initializeJWK",data:{JWK_public_key_PEM:i,JWK_public_key:null}}})},l=(await u(s,h)).id_token;return t({method:"POST",url:"https://server.othent.io/initialize-JWK",data:{PEM_key_JWT:l,API_ID:c}}).then((t=>t.data)).catch((t=>{throw console.log(t.response.data),t}))},JWKBackupTxn:async function(a){const e={iat:Math.floor(Date.now()/1e3),sub:a.sub,contract_id:a.contract_id,tags:a.tags,contract_input:{data:a.data,othentFunction:a.othentFunction}},o=a.privateKey,i=n(o,{private:!0}),s={alg:"RS256",typ:"JWT",exp:Math.floor(Date.now()/1e3)+3600},d=r.KJUR.jws.JWS.sign("RS256",JSON.stringify(s),JSON.stringify(e),i);return await t({method:"POST",url:"https://server.othent.io/JWK-backup-transaction",data:{JWK_signed_JWT:d,API_ID:c}}).then((t=>t.data)).catch((t=>{throw console.log(t.response.data),t}))},readCustomContract:async function(a){return await t({method:"POST",url:"https://server.othent.io/read-custom-contract",data:{contract_id:a.contract_id}}).then((t=>t.data)).catch((t=>{throw console.log(t.response.data),t}))},verifyArweaveData:async function(a){let n,r=await fetch(`https://arweave.net/tx/${a.transactionId}`,{headers:{responseType:"arraybuffer"}});(await r.json()).tags.map((t=>{"File-Hash-JWT"===atob(t.name)&&(n=e(atob(t.value)))}));const o=n.file_hash;let s=(await t.get(`https://arweave.net/${a.transactionId}`,{responseType:"arraybuffer"})).data;const c=await i(s);return o===c?{validData:!0,contract_id:n.contract_id,onChainHash:c,tagHash:o,iat:n.iat,userId:n.sub}:{validData:!1,onChainHash:c,tagHash:o}},verifyBundlrData:async function(a){let n,r=await fetch(`https://gateway.bundlr.network/tx/${a.transactionId}`,{headers:{responseType:"arraybuffer"}});(await r.json()).tags.map((t=>{"File-Hash-JWT"===t.name&&(n=e(t.value))}));const o=n.file_hash;let s=(await t.get(`https://arweave.net/${a.transactionId}`,{responseType:"arraybuffer"})).data;const c=await i(s);return o===c?{validData:!0,contract_id:n.contract_id,onChainHash:c,tagHash:o,iat:n.iat,userId:n.sub}:{validData:!1,onChainHash:c,tagHash:o}},encryptData:async function(t){const a=t.data,e=t.key;return{encryptedData:o.AES.encrypt(a,e).toString()}},decryptData:async function(t){const a=t.data,e=t.key,n=o.AES.decrypt(a,e);return{decryptedData:o.enc.Utf8.stringify(n)}},deployWarpContract:async function(a){var e;null!==(e=a.tags)&&void 0!==e||(a.tags=[]);const n=await i(a.contractSrc),r=await d(),o={transaction_input:JSON.stringify({othentFunction:"uploadData",file_hash:n})},s=(await u(r,o)).id_token;return await t({method:"POST",url:"https://server.othent.io/deploy-warp-contract",data:{contractSrc:a.contractSrc,contractState:a.state,JWT:s,tags:a.tags}}).then((t=>t.data)).catch((t=>{throw console.log(t.response.data),t}))}}})).catch((t=>{throw console.error("An error occurred:",t),t}))};
//# sourceMappingURL=index.js.map
